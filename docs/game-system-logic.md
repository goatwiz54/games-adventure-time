# ワールドマップ2 生成ロジック詳細仕様書 (Ver 1.0)

本ドキュメントは、`src/world2.go` および `src/types.go` の実装コードに基づき、ワールドマップ2の生成アルゴリズム、定数、パラメータの詳細を記述したものです。

## 1. 定数定義 (Constants)

### 1.1 タイルタイプ (Tile Types)
`src/types.go` で定義されているマップタイルの種類です。

| 定数名 | 値 | 説明 |
| :--- | :--- | :--- |
| `W2TileVariableOcean` | 0 | **変動海**: 陸地になりうる海。初期状態の大部分。 |
| `W2TileSoil` | 1 | **陸地**: 通常の地面。歩行可能。 |
| `W2TileFixedOcean` | 2 | **固定海**: マップ外周 (3マス分) など、常に海であることが保証される領域。 |
| `W2TileTransit` | 3 | **経由地**: 島と島、大陸を結ぶ飛び石状の浅瀬や小島。 |
| `W2TileCliff` | 4 | **崖**: 通行不可、または高コストの地形（実装予定）。 |
| `W2TileShallow` | 5 | **浅瀬**: 海と陸の境界、または航路周辺の海。 |

### 1.2 ソースタイプ (Source Types)
タイルの発生源を識別するためのIDです。

| 定数名 | 値 | 説明 |
| :--- | :--- | :--- |
| `SrcNone` | 0 | なし |
| `SrcMain` | 1 | **メイン大陸**: ランダムウォーカーによって生成された主要な陸地。 |
| `SrcSub` | 2 | サブ大陸 (未使用) |
| `SrcMix` | 3 | 混合 (未使用) |
| `SrcBridge` | 4 | **橋/経由地**: 航路生成時に配置されたタイル。 |
| `SrcIsland` | 5 | **島**: 広い海に生成された独立した島。 |
| `SrcTransitPath` | 6 | **航路**: 島と大陸を結ぶ経路。 |

### 1.3 生成フェーズ (Generation Phases)
生成プロセスの各ステップを管理するIDです。

| フェーズID | 定数名 | 説明 |
| :--- | :--- | :--- |
| 0 | `Phase_Init` | 初期化。固定海と変動海の配置。 |
| 1 | `Phase_MaskGen` | 形状マスクの生成。 |
| 2 | `Phase_SoilStart` | ランダムウォーカーの初期配置。 |
| 3-10 | (Soil Progress) | 陸地拡張の進行 (10%刻み)。 |
| 4 | (Tectonic Shift) | **地殻変動**: 生成途中で地形をずらすイベントが発生。 |
| 11 | `Phase_SoilProgressEnd` | 陸地生成完了。 |
| 13 | `Phase_Bridge` | 橋生成 (Type 1ではスキップ)。 |
| 14 | `Phase_Centering` | **センタリング**: 陸地全体をマップ中央へ移動。 |
| 15 | `Phase_IslandsQuad` | 4象限ごとの広い海探索と島生成。 |
| 16 | `Phase_IslandsRand` | ランダムな小島の追加。 |
| 17 | `Phase_Transit` | **航路生成**: 島と大陸を結ぶパスの探索。 |
| 18 | `Phase_CliffsShallows` | 崖と浅瀬の配置。 |
| 19 | `Phase_LakesFinal` | 湖の処理 (最終仕上げ)。 |

---

## 2. 生成パラメータ (Generation Config)

`NewGame()` (src/main.go) で初期化されるデフォルト設定値です。

| パラメータ | 変数名 | デフォルト値 | 説明 |
| :--- | :--- | :--- | :--- |
| **マップ幅** | `W2Width` | 150 | マップの横幅 (タイル数)。 |
| **マップ高さ** | `W2Height` | 100 | マップの縦幅 (タイル数)。 |
| **陸地率(最小)** | `SoilMin` | 20 (%) | 生成される陸地面積の最小目標値。 |
| **陸地率(最大)** | `SoilMax` | 40 (%) | 生成される陸地面積の最大目標値。 |
| **航路距離** | `TransitDist` | 20 | 島と大陸を結ぶ航路を生成する際の最小距離。 |
| **広い海のサイズ** | `VastOceanSize` | 15 | 島を生成するために必要な、何もない海の正方形サイズ (15x15)。 |
| **島の境界** | `IslandBoundSize` | 10 | 生成される島の最大サイズ。 |
| **センタリング** | `EnableCentering` | `true` | 生成後に陸地を中央に寄せるか。 |
| **崖初期値** | `CliffInitVal` | 0.3 | 崖生成のノイズ初期値。 |

---

## 3. 生成アルゴリズム詳細 (Generation Logic)

### 3.1 マスク生成 (Phase 1: Mask Gen)
`GenerateMask(w, h, typeID, rng)` 関数により、マップの形状を決定するマスクデータ (0.0 ~ 1.0) を生成します。

*   **Type 1 (クラシック):** 全体を 0.9 で埋める（ほぼ均一）。
*   **Type 2 (中央島):** 中心からの距離に応じて値を高くし、中央に陸地が集まりやすくする。
*   **Type 3-6 (大陸配置):** 左、上、右など特定方向に陸地を寄せる。
*   **Type 9 (勾玉):** 勾玉状の形状マスクを生成。

### 3.2 陸地生成 (Phase 2-11: Soil Generation)
**ランダムウォーカー (Random Walker)** アルゴリズムを使用します。

1.  **スポーン:** マップ中央付近に 10個のウォーカーを配置。
2.  **移動:** ウォーカーは上下左右に移動しながら、足元のタイルを `W2TileSoil` (Source: `SrcMain`) に変える。
3.  **方向決定:**
    *   移動先候補 (4方向) のマスク値 (`FinalMask`) にランダム値 (0.0~0.5) を加算し、スコアが最も高い方向へ移動する。
    *   これにより、マスク値が高い（陸地になりやすい）場所へ誘導される。
4.  **リスポーン:** マスク値が低い場所やマップ端に行き過ぎた場合、中央付近に再配置される。
5.  **終了条件:** 現在の陸地タイル数が `TargetSoilCount` (全タイルの 20~40%) に達するまで繰り返す。

### 3.3 地殻変動 (Phase 4: Tectonic Shift)
陸地生成の進行度が約 30% (Step 4) の時点で発生します。

1.  **シフト量:** マップサイズの 1/3 の範囲でランダムな `shiftX`, `shiftY` を決定。
2.  **移動:** 既存の `W2TileSoil` をすべて `(shiftX, shiftY)` だけずらす。
3.  **ラップアラウンド:** マップ外に出た部分は消滅せず、反対側から出現するわけではなく、境界チェックによりクリップされる（実装上は `tempGrid` へのコピー時に範囲外を除外）。
4.  **目的:** 自然な不規則性や、大陸の分断を表現する。

### 3.4 センタリング (Phase 14: Centering)
`EnableCentering` が `true` の場合のみ実行。

1.  **境界ボックス:** 現在の陸地 (`W2TileSoil`, `W2TileTransit`) が存在する最小/最大 X, Y を特定。
2.  **中心計算:** 陸地領域の中心点 (`contentCx`, `contentCy`) を計算。
3.  **シフト:** マップ自体の中心 (`w/2`, `h/2`) との差分を計算し、全タイルをその差分だけ移動させる。
4.  **効果:** 生成された大陸がマップの端に寄ってしまうのを防ぎ、常に画面中央に配置されるようにする。

### 3.5 島生成 (Phase 15-16: Islands)
大陸以外の空白地帯に島を生成します。

1.  **探索 (IslandsQuad):** マップを4分割 (4象限) し、各象限で `VastOceanSize` (15x15) の「陸地がない領域」を探す。
2.  **生成:** 見つかった領域の中心に、`IslandBoundSize` (10x10) の範囲内でランダムウォークを行い、島 (`SrcIsland`) を生成する。
3.  **ランダム追加 (IslandsRand):** 最後にランダムな座標を5箇所選び、海であれば1マスの小島を追加する。

### 3.6 航路生成 (Phase 17: Transit)
生成された島 (`SrcIsland`) と、最寄りの大陸 (`SrcMain`) を結ぶ航路を作ります。

1.  **距離計算:** 各島の中心から、最も近い「島以外の陸地」を探す。
2.  **条件:** 距離が `TransitDist` (20) 以上離れている場合のみ航路を生成。
3.  **パス生成:**
    *   始点から終点に向かって、少しずつ進む（線形補間 + ランダム性）。
    *   途中に `W2TileTransit` (経由地) を配置する。
    *   経由地は単なる1マスではなく、3x3 の範囲内でランダムウォークさせた「小島」として生成される。
    *   さらにその周囲に `W2TileShallow` (浅瀬) を配置し、自然な飛び石状の地形を作る。
