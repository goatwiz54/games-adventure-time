# ダンジョン探索RPG 総合仕様書 (Ver 4.0)

## 1. 基本システム概要
*   **ジャンル:** 資源管理型ローグライクRPG
*   **視点:** クォータービュー（斜め見下ろし・高低差あり）
*   **進行:** ターン制グリッド移動
*   **画面サイズ:** 1280 x 720 (ワイド)

## 2. 操作方法 (Input Mapping)

| 操作 | 機能 | 詳細 |
| :--- | :--- | :--- |
| **矢印キー** | 移動 | カメラの向きに合わせて補正された方向へ移動。連続入力（押しっぱなし）でスムーズに移動。 |
| **Shift + 矢印** | 方向転換 | その場で向きだけ変える。WTコスト 1/10。 |
| **Ctrl + ←/→** | **カメラ回転** | 90度単位でカメラを回転させる。滑らかなアニメーション。移動入力もこの向きに合わせて変化する。 |
| **Ctrl + マウスドラッグ** | **カメラ移動 (パン)** | プレイヤーを中心にせず、カメラ位置をずらして周囲を見る。移動するとプレイヤー中心に戻る。 |
| **F12** | ズーム拡大 | 0.8倍 → ... → 1.5倍。 |
| **Shift + F12** | ズーム縮小 | ... → 0.8倍 → 0.7倍。 |
| **F1** | デバッグ表示 | 全マップ・敵情報の可視化 (ON/OFF)。OFF時は記憶領域に戻る。 |
| **R** | 戦闘リセット | (開発用) 戦闘解除・周囲の敵消去。 |

## 3. 画面・描画システム
*   **描画アルゴリズム (Z-Sort):**
    *   画面奥（X+Yが小さい座標）から手前へ向かって、「床・壁」を描画した直後に「その上のキャラ」を描画する。これにより壁の手前/奥の重なりを正しく表現する。
*   **テクスチャ:**
    *   プログラム内生成によるドット絵風テクスチャ（草、土、石）。
*   **UI表示:**
    *   **プレイヤー頭上:** 現在の向きを示す半透明の矢印。
    *   **敵頭上:** 視界ランクが `Clear` / `Dim` の場合のみ、向きを示す矢印を表示。
    *   **方位磁針:** 現在のカメラ方角（N/E/S/W）を画面隅に表示。回転に合わせてアニメーション。

## 4. 時間・ターン・移動
*   **時間経過:** 1アクション（1マス移動）＝ 基本 **6分**。
*   **アニメーション:** マス間の移動は線形補間（Lerp）で滑らかに行う。
*   **探索WT (Wait Time):**
    *   パーティ平均WTが高いほど、戦闘時の手番は遅いが、探索時の1歩あたりの時間経過は固定。
    *   **重量ペナルティ**により、1歩あたりの経過時間（6分）に倍率がかかる。

## 5. キャラクター仕様

### 5.1 ステータス
| 項目 | 影響 |
| :--- | :--- |
| **HP / SP** | 耐久力 / スキルリソース |
| **STR** (筋力) | **最大積載量(kg)**、物理威力 |
| **DEX** (器用) | **インベントリ(マス)**、命中 |
| **VIT** (生命) | 最大HP、**インベントリ(マス)** |
| **INT** (知性) | **WT短縮**、魔法威力、鑑定 |
| **AGI** (敏捷) | **WT短縮(大)**、回避 |
| **SPD** (速度) | 移動速度係数、逃走 |
| **LUCK** (運) | クリティカル、ドロップ |

### 5.2 WT計算式
$$GameWT = BaseWT + \lceil 総重量 \rceil - \lfloor AGI \times 2.5 \rfloor - (INT \times 2)$$
*(下限値: 1)*

### 5.3 インベントリ容量
*   **スロット数:** $(VIT \times 3) + DEX$
*   **最大積載量(kg):** $STR \times 5$

### 5.4 重量ペナルティ (時間経過倍率)
| 重量比率 | 倍率 (1歩の時間) |
| :--- | :--- |
| ～84.9% | **1.0倍** (6分) |
| ～89.9% | **1.1倍** |
| ～94.9% | **1.2倍** |
| ～99.9% | **1.4倍** |
| 100%～ | **2.0倍** |

## 6. ダンジョン・AIシステム

### 6.1 視界 (Fog of War)
*   **指向性:** 前方は2マス先、横は1マス先、後ろは近くのみ見える。
*   **記憶:** 一度見た場所は、視界外になっても暗く表示され続ける。

### 6.2 敵AI
敵も視界を持ち、プレイヤーの見え方で行動が変わる。

1.  **敵視界 [Clear] (目前):**
    *   距離≦2の行動テーブル（追跡重視）。
    *   抽選が「ランダム」なら再抽選する（殺意高め）。
2.  **敵視界 [Dim] (側面・遠方):**
    *   追跡 30% / 停止 15% / ランダム 55%。
3.  **視界外:**
    *   完全ランダム or 遠距離用テーブル。

### 6.3 接敵
*   プレイヤーまたは敵が移動し、**距離が1以下**になった瞬間に戦闘モード（入力ロック）へ移行。

---

## 7. 未決定・詳細定義待ち項目 (+@一覧)

ここまでのチャットで「後で決める」「詳細は別途」となっていた項目の一覧です。
**これらが決まると、ゲームとして完全に遊べる状態になります。**

### A. 戦闘システム詳細
*   **戦闘画面:** マップ上でそのまま戦うか（FFT方式）、専用画面に切り替わるか。
*   **コマンド:** 「たたかう」「防御」「スキル」「アイテム」「逃げる」の仕様。
*   **ダメージ計算式:** 攻撃力 - 防御力 なのか、倍率計算なのか。
*   **命中・回避:** DEXとAGIを使った具体的な判定式。
*   **死亡処理:** HP0で即消滅か、蘇生猶予があるか。全滅時の処理（所持金25%ロスト以外に、死体回収などはあるか）。

### B. アイテム・装備・経済
*   **武具の種類:** 剣・槍・斧・弓・杖・盾・鎧・兜・小手・具足・アクセサリのパラメータ定義。
*   **耐久度 (消耗):**
    *   攻撃/被弾のたびに減るのか？
    *   0になったら「壊れて消滅」か「性能激減（修理可能）」か。
*   **修理:** どこでできるか（街の鍛冶屋？ダンジョン内で修理キット？）。コスト計算。
*   **鑑定:** 未鑑定アイテムの概念と、INT依存の鑑定成功率。
*   **通貨レート:** 国ごとの通貨価値が変動する具体的なトリガーと計算式。

### C. 成長・スキル・魔法
*   **経験値:** 敵ごとの獲得量計算。
*   **レベルアップ:** 必要経験値テーブル。ステータス上昇はランダムか固定か。
*   **スキル/魔法:** 具体的なリスト（ファイアボール、ヒール、パワーアタック等）と消費SP、射程、効果範囲。

### D. 街・施設
*   **施設メニュー:**
    *   **宿屋:** 宿泊費の計算、HP/SP全回復、セーブ機能。
    *   **酒場:** クエスト受注のUI、噂話（ヒント）。
    *   **ギルド:** 冒険者ランク昇格試験、スキル習得。
    *   **商店:** 売買のUI、在庫の概念。

### E. その他
*   **加齢:** 誕生日が来た時のステータス低下処理の詳細（どのステータスが下がりやすいか等）。
*   **セーブデータ:** データ構造の定義（JSON等）。オートセーブのタイミング。
*   **階層移動:** 階段を下りた時の処理（敵リセット？フロア生成し直し？）。