<!-- filename: game-system-detail.md -->
# Tactics Dungeon RPG 開発仕様書 (Ver 13.0 - 最新版)

## 1. 基本コンセプト
*   **ジャンル:** 資源管理型ローグライクRPG
*   **視点:** クォータービュー (Isometric)
*   **システム:** Go言語 + Ebitengine (v2)
*   **進捗:** WorldMap2 の生成ロジックの修正が完了。Enterによる自動実行とポーズ処理を実装。

---

## 2. ワールドマップ2 生成仕様

### 2.1 地形タイル定義
| ID | 名称 | Source | 色(RGB) | 特性 |
|:--|:---|:---|:---|:---|
| 0 | 可変海 (Var Ocean) | - | 30, 60, 180 (湖: 60, 100, 200) | 土に変化可能な海。 |
| 1 | 土 (Soil) | *Source依存* | 180, 100, 80 (Main) など | 通常の陸地。 |
| 2 | 固定海 (Fixed Ocean) | - | 10, 20, 80 | マップ外周3マス。侵食不可。 |
| 3 | 経由島 (Transit) | SrcBridge | 200, 180, 80 (黄土) | 大陸と島を繋ぐ飛び石。 |
| 4 | 崖 (Cliff) | - | 80, 40, 10 (濃茶) | 切り立った高地。 |
| 5 | 浅瀬 (Shallow) | - | 60, 160, 200 (水色) | 陸地に接する浅い海。 |

### 2.2 土の発生源 (Source)
生成ロジックの由来を可視化するための属性。
| ID | 名称 | 描画色 (world2.go) |
|:--|:---|:---|
| 1 | SrcMain | 赤茶 |
| 5 | SrcIsland | 黄土（孤立島） |
| 6 | **SrcTransitPath**| **40, 80, 160 (浅瀬より暗い青)** |

---

## 3. 生成アルゴリズム (フェーズ進行)

### 【Phase 6】 Islands (Quad) の動作 (ポーズ機能付き)
1.  マップを4象限に分割。
2.  各象限内で $Vast \times Vast$ の**広い海**エリアを探索。
3.  広い海が見つかった場合、そのエリアを**浅瀬の色（`PinkRects`）**で強調表示し、`Gen2IsPaused = true` と設定して**ポーズする**。
4.  ポーズ中、ユーザーが `PgDn` または `Enter` を押すとポーズが解除され、以下の処理が実行される。
    *   **Enter/PgDn (ポーズ解除時):** 見つかった広い海エリアの中心から、`IslandBound`の範囲内で**ランダムウォークによる島（SrcIsland）**を生成し、次の象限の探索に進む。

### 【Phase 8】 Transit Islands のロジック詳細

*   **目的**: 大陸と孤立島を繋ぐ経由地と航路を生成する。
*   **経由島の生成**:
    *   **サイズ**: **3x3** マスエリア。
    *   **形状**: その3x3エリア内で、**ランダムウォークにより 4〜7タイル**の `W2TileTransit`（SrcBridge）を生成する。
    *   **浅瀬**: 生成された経由島の周囲（5x5エリア）の海域から、**ランダムな3か所**に `W2TileShallow` を生成する。
*   **航路のマークアップ**:
    *   大陸側の陸地から経由島へ向かう軌跡上の海タイルに、**`SrcTransitPath`** を設定する。これにより、航路が浅瀬より暗い青色で可視化される。

---

## 4. 実行時のキー操作 (WorldMap2)

| キー | 動作 | 備考 |
|:---|:---|:---|
| **Enter** | **[全自動実行]** 完了するまで連続して `NextStep()` を実行する。ポーズが発生した場合は、そのポーズを無視せず中断する。完了状態 (`Phase 10`) で押すとリセットし、自動生成を開始する。|
| **PgDn** | **[1ステップ実行]** 次のフェーズまたはステップに進む。|
| **PgUp** | **[アンドゥ]** 1つ前のスナップショットに戻る。 |
| **R** | **[リセット]** マップ生成を初期状態からやり直す。|
| **Ctrl + Drag** | カメラ移動 | |
| **Ctrl + Wheel**| ズーム | |