# タクティクス・ダンジョンRPG 開発仕様書 (Ver 13.0)

## 1. プロジェクト基本情報
*   **画面解像度:** 1280 x 720 (ウィンドウモード)
*   **タイルサイズ:**
    *   ダンジョン: 64x32 (Isometric)
    *   ワールドマップ: 16x16 (Flat Grid)
*   **基本操作:** キーボード (矢印, Shift, Ctrl, Enter) + マウス

---

## 2. ワールドマップ2 生成アルゴリズム (World Map 2 Generation)
**方式:** ステートマシンによる段階的生成 (Step-by-Step)

### 2.1 基本パラメータ (UI入力可)
*   **Map Size:** $W \times H$ (デフォルト 150x100, 最小 40x40, 最大 500x500)
*   **Soil Ratio:** 土の総数目標 (Min% ～ Max% からランダム決定)
*   **Transit Dist:** 経由島生成の閾値距離 (デフォルト 15)
*   **Vast Ocean:** 島生成に必要な海域サイズ (デフォルト 25)
*   **Island Bound:** 島生成のランダムウォーク範囲 (デフォルト 15)
*   **Cliff Params:**
    *   `Cliff Init`: 10.0 (初期倍率)
    *   `Cliff Dec`: 0.1 (成功時減少値)
    *   `Shallow Dec`: 0.25 (失敗時減少値)

### 2.2 生成フロー詳細

#### Step 0: 初期化 (Initialization)
1.  全タイルを **可変海 (Variable Ocean)** で埋める。
2.  外周3マスを **固定海 (Fixed Ocean)** で上書きする。
    *   *固定海は浸食されず、土にもならない絶対的な境界線。*

#### Step 1: マスク生成 (Mask Generation)
大陸形状の設計図（0.0～1.0）を作成する。
*   **Type 1 (クラシック):**
    *   基本値 0.9。中央付近 ($Distance < Radius \times 0.5$) は 1.0 に補正。
*   **合成:** (現在はType 1固定だが、内部ロジックはブレンド対応)
    *   $Mask = Main \times \frac{Ratio}{10} + Sub \times (1 - \frac{Ratio}{10})$
*   **目標土数決定:** $\text{Target} = (W \times H) \times \text{Random}(Min\%, Max\%)$

#### Step 2: 土の配置開始 (Soil Start)
*   **スポーン:**
    *   Type 1 の場合、中央付近からランダムに開始点を選ぶ。
    *   それ以外の場合、マスク値 $> 0.6$ の地点から選ぶ。
*   **ウォーカー:** 10体を生成。

#### Step 3～: 土の拡張 (Soil Progress)
目標数に達するまでランダムウォークを行う。
1.  **移動:** 隣接マスのマスク値を参照し、高い方へ確率的に移動。
2.  **配置:** 移動先を **土 (Soil)** に変える。
    *   **Source (色):** マスク値を参照して決定 (Main/Sub/Mix/Island)。
    *   **Highlight:** 新規配置箇所を `NewSoils` として記録（描画時に明るく表示）。
3.  **地殻変動 (Tectonic Shift):**
    *   土の生成率が **約30%** (Step 4) に達した時点で発動。
    *   **X軸移動:** Random $\pm W/3$
    *   **Y軸移動:** Random $\pm H/3$
    *   **衝突判定:** 移動後に固定海と重なる場合、逆方向に5マス戻す。

#### Step 7: 連結諸島補強 (Bridges)
*   Type 8 (連結諸島) が含まれる場合のみ。
*   ランダムな土と土の間をブレゼンハム直線で結び、**SrcBridge (灰色)** の土にする。

#### Step 8: センタリング (Safe Centering)
*   `Centering = ON` の場合のみ。
*   全陸地の重心を計算し、マップ中央へシフトさせる。
*   外周3マスを固定海で再上書き（はみ出し防止）。

#### Step 9: 隙間埋め島 (Islands Quad)
1.  画面を4分割。各エリアで `Vast Ocean` サイズの空白海域を探索。
2.  **可視化:** 発見エリアを **ピンク色の矩形** で表示。
3.  **生成:** 中心から `Island Bound` 範囲内でランダムウォークし、島 (`SrcIsland`) を作る。
    *   島サイズ: Bound面積の 30%～70%。

#### Step 10: ランダム小島 (Islands Random)
*   大陸から離れた位置に、確率でごく小さな島を配置。

#### Step 11: 経由島 (Transit Islands)
大陸から孤立した島を救済する。
1.  各島から「自分以外の土」への最短距離 $D$ を計算。
2.  $D \ge \text{Transit Dist}$ の場合、大陸へ向かうベクトル上で **5～8マス** 進んだ地点に小島を作る。
3.  **隣接打ち切り:** 次の生成地点が、目的地の島に隣接する場合は生成しない。
4.  距離が縮まるまで繰り返す（ステップストーン）。

#### Step 12: 崖と浅瀬 (Cliffs & Shallows)
海岸線に詳細な地形を付与する。
1.  **ループ:** `Multiplier > 0` の間繰り返す。
2.  **経路探索:** 海岸線の土Aから土Bへの経路C（長さ $\le 5$）を探す。
3.  **確率判定:** $P = \text{Length} \times Multiplier$
    *   **成功:** Cを **崖 (Cliff)** に変更。`Multiplier -= Cliff Dec`
    *   **失敗:** Cの周囲の海を **浅瀬 (Shallow)** に変更。`Multiplier -= Shallow Dec`
        *   浅瀬が密集している場合、さらに沖へ拡張する。

#### Step 13: 湖判定 (Finalize)
1.  固定海から水域を塗りつぶし探索 (Flood Fill)。
2.  到達不可な「可変海」「浅瀬」を **湖 (Lake)** に変更。
3.  最終的な統計情報を集計。

---

## 3. 未決定・検討タスク (+@List)

### A. マップ活用 (Gameplay)
*   **移動コスト:** 崖、浅瀬、森などの移動コスト定義（仕様書Ver1.1参照）の適用。
*   **国割り当て:** 生成された「土」の塊に対して、どうやって国境線を引くか。
    *   *案: 主要都市をランダム配置し、ボロノイ図で勢力圏を決める。*

### B. データ保存 (Persistence)
*   **シリアライズ:** 生成された `Tiles` 配列と `Enemies` リストを JSON またはバイナリで保存/読み込みする機能。

### C. 戦闘 (Combat)
*   **バトル移行:** エンカウント時の演出と、戦闘用UIへの切り替え。
*   **ダメージ計算:** 具体的な計算式の確定。

### D. 経済 (Economy)
*   **交易:** 都市ごとの特産品設定と価格変動ロジック。